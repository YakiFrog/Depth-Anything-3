# ループクロージャー・ワークフローのまとめ

軌跡を正しく閉じ、累積誤差（ドリフト）を補正するための一連の技術プロセスをまとめます。

## ステップ1：グローバルなループ検出 (SALAD)

単に「似ている画像」を探すだけでなく、軌跡を修正するために真に有効な「再会」地点を特定します。

*   **技術:** SALAD (ディープラーニング記述子)
*   **プロセス:**
    1.  全てのフレーム画像から「指紋（記述子）」を抽出。
    2.  現在の地点と、過去の全ての地点の記述子を比較し、類似スコアを算出。
    3.  **フィルタ環:** 非常に近いフレーム（例：200フレーム以内）は、見た目が似ていても累積誤差の修正には寄与せず、逆に軌跡を歪める（崩れる）原因となるため、`min_loop_distance` で除外します。
    4.  一定以上の類似度かつ、物理的に遠い場所からの再会のみを「ループ候補」として採用します。

## ステップ2：Sim(3) 相対ポーズの推定 (点群アライメント)

検出された2地点の間で、具体的にどれだけ位置と「尺度の差（スケール）」があるかを算出します。

*   **技術:** Point Cloud Registration (点群マッチング)
*   **プロセス:**
    1.  ループ候補となる2つのフレームから、推定された深度データとカメラパラメータを用いて3D点群を生成。
    2.  2つの点群を重ね合わせる最適な変換行列を求めます。
    3.  ここでの核となるのが **Sim(3)** です。通常の回転(R)・平行移動(t)に加え、単眼SLAM特有の問題である **「尺度のズレ(s)」** も含めて計算します。

## ステップ3：全局ポーズグラフ最適化 (Sim(3) Optimization)

ループで発見された「ズレ」の情報を、全軌跡にわたって滑らかに分配・解消し、最終的な軌跡を確定させます。

*   **技術:** Sim(3) Pose Graph Optimization
*   **プロセス:**
    1.  全フレームのポーズをノード、フレーム間の接続とループ接続をエッジとしたグラフを構築します。
    2.  ループ接続によって生じた「矛盾（ジャンプ）」を最小化するように、全体のポーズとスケールを微調整（非線形最適化）します。
    3.  **成功の印:** 軌跡の終点が始点とぴたりと重なり、スケールドリフトが補正された一貫性のあるマップが完成します。

> [!TIP]
> **スケールが小さくなる現象について**
> 最適化後に全体が少し小さくなったのは、移動が進むにつれて推定尺度が実際より大きく膨らんでいた（ドリフトしていた）ことをシステムが正しく検出し、ループを閉じる際に正しいサイズに「絞り込んだ」結果です。これは最適化が理想的に機能したことを示しています。
